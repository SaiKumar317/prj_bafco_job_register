import jsPDF from "jspdf";
import "jspdf-autotable";
import moment from "moment";

export const generateCostEntryPdf = (
  costEntry = [],
  selectedJob = {},
  costDate = ""
) => {
  const doc = new jsPDF();

  const formatDate = (date) => (date ? moment(date).format("DD/MM/YYYY") : "");

  // --- Title ---
  const title = `Cost Entry Report`;
  doc.setFontSize(14);
  doc.text(title, 105, 10, { align: "center" });

  doc.setFontSize(10);

  // --- Job Info (2 fields per row, now includes Cost Date) ---
  const jobDetails = [
    ["Job Id", selectedJob.jobName ?? ""],
    ["Cost Date", formatDate(costDate)],
    ["Total Sales", selectedJob.totalSales ?? ""],
    ["Total Cost", selectedJob.totalCost ?? ""],
    ["Profit/(Loss) - NoTax", selectedJob?.profitLossNoTax ?? ""],
    ["Cost Locked", selectedJob.costLocked ? "Yes" : "No"],
  ];

  let y = 20;
  jobDetails.forEach((_, index) => {
    if (index % 2 === 0) {
      const [label1, value1] = jobDetails[index];
      const [label2, value2] = jobDetails[index + 1] || ["", ""];

      // --- Left Label ---
      doc.setTextColor(0, 0, 0);
      doc.text(`${label1}:`, 14, y);

      // --- Left Value (Profit/Loss check) ---
      if (label1 === "Profit/(Loss) - NoTax") {
        const cleanVal = (value1 || "").toString().replace(/[^\d.-]/g, "");
        const numericVal = parseFloat(cleanVal);

        if (!isNaN(numericVal)) {
          if (numericVal < 0) {
            doc.setTextColor(255, 0, 0); // ðŸ”´ red
          } else {
            doc.setTextColor(0, 128, 0); // ðŸŸ¢ green
          }
        } else {
          doc.setTextColor(0, 0, 0);
        }
      } else {
        doc.setTextColor(0, 0, 0);
      }
      doc.text(String(value1), 50, y);

      // --- Right Label and Value (normal) ---
      doc.setTextColor(0, 0, 0);
      doc.text(`${label2}:`, 110, y);
      doc.text(String(value2), 150, y);

      y += 6;
    }
  });

  // --- Table Columns ---
  const columns = [
    { header: "Vendor Id", dataKey: "vendorAcc" },
    { header: "INV #", dataKey: "vendorInvNo" },
    { header: "INV Date", dataKey: "vendorInvDate" },
    { header: "Credit", dataKey: "purchaseAcc" },
    { header: "0 Tax Cost", dataKey: "zeroTaxCost" },
    { header: "Tax Cost", dataKey: "taxCost" },
    { header: "Tax Amount", dataKey: "taxAmount" },
    { header: "Total Cost", dataKey: "totalCost" },
    { header: "EIR Id", dataKey: "eirId" },
    { header: "Challan", dataKey: "challan" },
    { header: "Cntr #", dataKey: "containerNo" },
    { header: "Narration", dataKey: "sRemarks" },
  ];

  const rows = costEntry.map((entry) => ({
    vendorAcc: entry.vendorAcc || "",
    vendorInvNo: entry.vendorInvNo || "",
    vendorInvDate: formatDate(entry.vendorInvDate),
    purchaseAcc: entry.purchaseAcc || "",
    zeroTaxCost: entry.zeroTaxCost ?? "",
    taxCost: entry.taxCost ?? "",
    taxAmount: entry.taxAmount ?? "",
    totalCost: entry.totalCost ?? "",
    eirId: entry.eirId || "",
    challan: entry.challan || "",
    containerNo: entry.containerNo || "",
    sRemarks: entry.sRemarks || "",
  }));

  // --- AutoTable ---
  doc.autoTable({
    startY: y + 4,
    head: [columns.map((col) => col.header)],
    body: rows.map((row) => columns.map((col) => row[col.dataKey])),
    styles: {
      fontSize: 8,
      cellPadding: 2,
      overflow: "linebreak",
      valign: "middle",
      textColor: [0, 0, 0], // âœ… Black text for all grid content
      lineColor: [204, 204, 204], // âœ… Light border color (#ccc)
      lineWidth: 0.1,
    },
    headStyles: {
      fillColor: [68, 121, 155], // âœ… Header background: #44799b
      textColor: [255, 255, 255], // âœ… White header text
      fontStyle: "bold",
      halign: "center",
      lineColor: [204, 204, 204], // âœ… Light border on header too
      lineWidth: 0.1,
    },
    alternateRowStyles: {
      fillColor: [245, 245, 245],
    },
    columnStyles: {
      4: { halign: "right" },
      5: { halign: "right" },
      6: { halign: "right" },
      7: { halign: "right" },
    },
    margin: { left: 14, right: 14 },
    theme: "grid",
    didDrawPage: function (data) {
      const pageCount = doc.internal.getNumberOfPages();
      const pageSize = doc.internal.pageSize;
      const pageHeight = pageSize.height;

      doc.setFontSize(8);
      doc.text(
        `Page ${doc.internal.getCurrentPageInfo().pageNumber} of ${pageCount}`,
        pageSize.width / 2,
        pageHeight - 10,
        { align: "center" }
      );
    },
  });

  // --- Save the PDF ---
  doc.save("Cost-Entry-Report.pdf");
};
