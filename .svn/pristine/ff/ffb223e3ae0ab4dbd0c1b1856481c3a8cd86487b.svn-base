import ExcelJS from "exceljs";
import { saveAs } from "file-saver";

export const generateJobDocumentsExcel = async (attachmentsData = []) => {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet("Job Documents");

  // ðŸ”¹ Title
  worksheet.mergeCells("A1:D1"); // 4 columns = A to D
  const titleCell = worksheet.getCell("A1");
  titleCell.value = "Job Documents Report";
  titleCell.font = { size: 16, bold: true };
  titleCell.alignment = { vertical: "middle", horizontal: "center" };
  worksheet.addRow([]); // Empty row after title

  // ðŸ”¹ Headers (matching the <th>)
  const headers = [
    "Attachment Id",
    "File Name",
    "Path Name",
    "Attachment Type Name",
  ];
  worksheet.addRow(headers);

  // ðŸ”¹ Header Styling
  const headerRow = worksheet.getRow(3);
  headerRow.font = { bold: true, color: { argb: "FFFFFF" } };
  headerRow.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "44799B" }, // Blue header background
  };
  headerRow.alignment = { horizontal: "center", vertical: "middle" };

  // ðŸ”¹ Freeze Header
  worksheet.views = [
    {
      state: "frozen",
      ySplit: 3,
    },
  ];

  // ðŸ”¹ Add Data Rows
  attachmentsData.forEach((entry) => {
    worksheet.addRow([
      entry.attachedId || "",
      entry.fileName || "",
      entry.pathName || "-",
      entry.attachmentTypeName || "",
    ]);
  });

  // ðŸ”¹ Format Rows: Borders + Alignment
  worksheet.eachRow((row, rowNumber) => {
    if (rowNumber >= 3) {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: "thin" },
          bottom: { style: "thin" },
          left: { style: "thin" },
          right: { style: "thin" },
        };
        cell.alignment = { horizontal: "left", vertical: "middle" };
      });
    }
  });

  // ðŸ”¹ Auto Width for All Columns
  worksheet.columns.forEach((column) => {
    let maxLength = 0;
    column.eachCell({ includeEmpty: true }, (cell) => {
      const columnLength = cell.value ? cell.value.toString().length : 10;
      if (columnLength > maxLength) {
        maxLength = columnLength;
      }
    });
    column.width = maxLength < 20 ? 20 : maxLength + 2;
  });

  // ðŸ”¹ Export File
  const buffer = await workbook.xlsx.writeBuffer();
  saveAs(new Blob([buffer]), "Job-Documents-Report.xlsx");
};
