import ExcelJS from "exceljs";
import { saveAs } from "file-saver";

export const generateJobRegisterExcel = async (jobData = []) => {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet("Job Register");

  // ðŸ”¹ Title
  worksheet.mergeCells("A1:R1");
  const titleCell = worksheet.getCell("A1");
  titleCell.value = "Job Register Report";
  titleCell.font = { size: 16, bold: true };
  titleCell.alignment = { vertical: "middle", horizontal: "center" };
  worksheet.addRow([]); // Empty row after title

  // ðŸ”¹ Define Headers (same as your <th> structure)
  const headers = [
    "Job Id",
    "Date",
    "Ship/Consg",
    "PO Ref",
    "Ship Line",
    "Status",
    "Vessel",
    "ETA Date",
    "POL",
    "POD",
    "MBL",
    "HBL",
    "Handle By",
    "FR-TERM",
    "Invoice#",
    "Branch",
    "Salesman",
    "Operation",
  ];
  worksheet.addRow(headers);

  // ðŸ”¹ Header Styling
  const headerRow = worksheet.getRow(3);
  headerRow.font = { bold: true, color: { argb: "FFFFFF" } };
  headerRow.fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "44799B" }, // Blue header background
  };
  headerRow.alignment = { horizontal: "center", vertical: "middle" };

  // ðŸ”¹ Freeze Header
  worksheet.views = [
    {
      state: "frozen",
      ySplit: 3,
    },
  ];

  // ðŸ”¹ Add Job Data Rows
  jobData.forEach((job) => {
    worksheet.addRow([
      job.jobName,
      job.docDate,
      job.ShippingConsignmentCode || "NA",
      job.PORef || "",
      job.shippingLine || "",
      job.jobStatus || "",
      job.vessel || "",
      job.Arrival || "",
      job.portLoading || "",
      job.portDestination || "",
      job.MblNoHeader || "",
      job.HblNoHeader || "",
      job.handleBy || "",
      job.FreightTerms || "",
      job.invoice || "",
      job.branch || "",
      job.salesman || "",
      job.operationType || "",
    ]);
  });

  // ðŸ”¹ Format Rows: Borders + Alignment
  worksheet.eachRow((row, rowNumber) => {
    if (rowNumber >= 3) {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: "thin" },
          bottom: { style: "thin" },
          left: { style: "thin" },
          right: { style: "thin" },
        };
        cell.alignment = { horizontal: "center", vertical: "middle" };
      });
    }
  });

  // ðŸ”¹ Auto Width for All Columns
  worksheet.columns.forEach((column) => {
    let maxLength = 0;
    column.eachCell({ includeEmpty: true }, (cell) => {
      const columnLength = cell.value ? cell.value.toString().length : 10;
      if (columnLength > maxLength) {
        maxLength = columnLength;
      }
    });
    column.width = maxLength < 20 ? 20 : maxLength + 2;
  });

  // ðŸ”¹ Export File
  const buffer = await workbook.xlsx.writeBuffer();
  saveAs(new Blob([buffer]), "Job-Register-Report.xlsx");
};
